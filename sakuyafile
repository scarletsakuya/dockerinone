FROM library/debian:latest

ENV ROOT_PASS=root
ENV HTTP_USER=sakuya
ENV LANG=en_US.UTF-8 LANGUAGE=en_US:en LC_ALL=en_US.UTF-8
ENV TZ=Asia/Shanghai
ENV TOKEN=88888888:00000000000000000
ENV USER=999999999

COPY autostart.sh /etc/init.d/autostart.sh

RUN set -ex \
    && echo "deb http://ftp.de.debian.org/debian testing main" | tee -a /etc/apt/sources.list \
    && apt-get update \
    && apt-get -t testing install python3.6 python3-distutils -y \
    && apt-get install -yqq vim openssh-server wget locales tzdata lrzsz curl squid3 nghttp2 \
    ffmpeg libmagic-dev libwebp-dev python3-pip screen \
    # set time etc
    && locale-gen en_US.UTF-8 \
    && ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone \
    && echo "Asia/Shanghai" > /etc/timezone \
    && dpkg-reconfigure -f noninteractive tzdata \
    # ssh set 
    && sed -ri 's/^PermitRootLogin\s+.*/PermitRootLogin yes/' /etc/ssh/sshd_config \
    && sed -ri 's/UsePAM yes/#UsePAM yes/g' /etc/ssh/sshd_config \
    # set password for ssh and nghttp
    && echo root:${ROOT_PASS}|chpasswd \
    && htpasswd -b -c /etc/squid/password ${HTTP_USER} ${ROOT_PASS} \
    # set v2ray
    && curl -L -o /tmp/go.sh https://install.direct/go.sh \
    && chmod +x /tmp/go.sh \
    && /tmp/go.sh \
    # install ehforwarderbot
    && python3.6 -m pip install --upgrade pip \
    && python3.6 -m pip install ehforwarderbot \
    && python3.6 -m pip install efb-telegram-master \
    && python3.6 -m pip install efb-wechat-slave \
    # create dir and files
    && mkdir -p /var/run/sshd \
    && mkdir -p /root/.ehforwarderbot/profiles/default/ \
    && mkdir -p /root/.ehforwarderbot/profiles/default/blueset.telegram \
    && touch /root/.ehforwarderbot/profiles/default/config.yaml \
    && touch /root/.ehforwarderbot/profiles/default/bluestet.telegram\config.yaml \
    && echo "master_channel: blueset.telegram \	slave_channels: \- blueset.wechat" | tee /root/.ehforwarderbot/profiles/default/config.yaml \
    && echo "taken:\"${TOKEN}\" \admins: \- ${USER} " | tee /root/.ehforwarderbot/profiles/default/bluestet.telegram\config.yaml \
    # add auto-start services
    && chmod /etc/init.d/autostart.sh \
    && update-rc.d /etc/init.d/autostart.sh defaults \
    && update-rc.d -f /etc/init.d/autostart.sh \
    # make clean
    && apt-get clean \
    && apt-get autoclean \
    && apt-get autoremove \
    #&& dpkg --list | grep "^rc" | cut -d " " -f 3 | xargs dpkg --purge \
    && rm -rf /tmp/* /root/.cache /var/lib/apt/lists/*

COPY nghttp.conf /etc/nghttpx/nghttpx.conf
COPY squid.conf /etc/squid/squid.conf

EXPOSE 22
EXPOSE 5061
EXPOSE 20443
EXPOSE 1434
EXPOSE 3389

CMD ["/usr/sbin/sshd", "-D"]
